## What is Ghidra?
   - Ghidra is a reverse engineering tool that was developed by the NSA and released in 2019.
   - This allows a malware analyst to inspect the functionality of a malware sample without running it, this is extremely useful as the analyst is able to look through the code of the malware and map out what it is doing.
   - A disassembly tool such as Ghidra doesn’t run the code, it maps out the assembly code of the malware and allows the user to step forward and backward through the code without impacting the filesystem of the analysis device.

## How to install Ghidra
   To install Ghidra on Windows, navigate to the official [Ghidra](https://ghidra-sre.org/) website, you will be presented with the following page:
   
   Select ‘Download from Github’, this will take you to the Ghidra Github page, where the latest version of the software can be downloaded.
   ![[ghidra1.webp]]
   
**Download the zip file and extract the contents to a location of your choice, once extracted you should have the following files:**
   ![[ghidra2.webp]]
   
**To launch Ghidra, double click the Windows batch file called ‘ghidraRun’, you may see the following error message:**
   ![[ghidra3.webp]]
   If this happens then use this [video](https://www.youtube.com/watch?v=Es3ebWUBiqc) I created to quickly resolve the issue.
   
**Once opened the following windows will be displayed, the ‘Active Project’ window and the ‘Tip of the Day’ window. The ‘Tip of the Day’ window is quite self-explanatory and can be closed.**
   ![[ghidra4.webp]]
   
**To begin using Ghidra to analyze a sample you first need to create a project which is used to store the sample and any files generated by Ghidra.**
   **To begin, select ‘File’, then ‘New Project’.**
   ![[ghidra5.webp]]
   
**Select whether you want to share the project or not, in this example, I will choose ‘Non-Shared Project’ and click ‘Next’.**
   ![[ghidra6.webp]]
   
**Next, give the project a name, this could be the name of the malware sample being analyzed, and click ‘Finish’. In this example, I have used ‘Varonis Demo’**
   ![[ghidra7.webp]]
   
**We now have a newly created project and can import through "Top left file > import File..." malware samples into the project for analysis.**
  ![[ghidra8.webp]]
 In the image above we can see a file that has been added to the project called ‘remcos.exe’, and Ghidra is telling us it has identified the file as a 32bit Windows PE file.

**Click ok and Ghidra will begin to import the file, the following status bar will be displayed:
   ![[ghidra9.webp]]
   
**Once the file has successfully been imported into Ghidra the following window will be displayed that provides details on the imported file.**
   ![[ghidra10.webp]]
   Select ‘OK’, and then double click the name of the imported malware or press the dragon logo icon to open the code browser.
   
**The following prompt will appear advising that Ghidra has not yet analyzed the file and asks if you would like to analyze it now, select ‘Yes’.**
   ![[ghidra11.webp]]

**The following window will then be displayed regarding analysis options, from here select the option that I have highlighted called ‘WindowsPE x86 Propagate External Parameters’. This helps when analyzing an imported function as the parameters for the function that will be pushed onto the stack will be listed within the tool.**
   ![[ghidra12.webp]]

**Select ‘Analyze’, and Ghidra will begin to analyze the file, the status bar at the bottom right-hand corner of Ghidra will display a status bar showing the progress of the analysis.**
![[ghidra13.webp]]
Once this has finished Ghidra is ready for you to begin reverse engineering the malware sample.

## Reverse Engineering Using Ghidra
  When you open a piece of malware in Ghidra that has been imported and analyzed by the tool you will see a number of windows.

### Main Ghidra Windows
  
 **In the top left-hand corner, there is a window that contains the sections of the malware, this is the ‘Program Trees’ section. If you have used a tool such as [PeStudio](https://www.varonis.com/blog/pestudio/?hsLang=en) before then this should be familiar.**
  ![[ghidra14.webp]]

**The ‘Symbol Tree’ section is very useful as this contains the imports, exports, and functions that the malware is using to perform its malicious activities.**
![[ghidra15.webp]]

**By clicking on ‘Imports’ we can see which libraries have been imported by the malware, clicking on a DLL reveals the imported functions associated with that library.**
![[ghidra16.webp]]
- From looking through the imports it is then possible to identify any interesting functions that the malware is using, this is great for a malware analyst as it means we can double click on these imports to see if they are being used by the malware and try to understand what activity it may perform on a compromised host.

- The same can be done with the Exports tab to see what functionality has been exported by the malware, however, there are no exports in the malware sample in this demo.

**In the image below one of the functions is named ’CreateToolhelp32Snapshot’, this is the name of an imported function that is used to enumerate the running processes on a device, so Ghidra has seen this import being used in this function and named it accordingly.**
![[ghidra17.webp]]
- The ‘Symbol Tree’ contains all the functions that have been written by the malware author. When Ghidra imports and then analyses the malware, it will attempt to assign names to some of the functions based on the automated analysis it has performed.
- We can also see some functions that have a generic naming convention that begins with ‘FUN_’ and then a series of numbers. These are functions that have not been defined by Ghidra so are named ‘FUN_’, which is short for function, and then given a hexadecimal numeric value that represents where the function is located within the binary.


**There is also a listing for ‘entry’, this is the entry point of the malware, and by double-clicking this the main ‘Listing’ window of Ghidra will be updated and display the assembly code at the entry point of the malware.**
![[ghidra18.webp]]
- In the image above we can see the assembly instructions and information being pushed onto the stack and various calls being made. This information can give us an idea of what the malware is doing by focusing on any calls to interesting APIs that are listed in the ‘Symbol Tree’ window of Ghidra.

**By clicking on ‘entry’, the ‘Decompile’ window will now be updated and contain some data.**
![[ghidra19.webp]]
This window shows where Ghidra has attempted to convert the assembly code in the ‘Listing’ window into the C programming code. This allows the malware analyst to see what the malware author's code may have looked like and help assist with the analysis of the malware.


### Function Graph

   **Another display that will assist with analysing malware is using the function graph, this can be used by selecting the ‘Display Function Graph’ icon on the Ghidra toolbar.**
   ![[ghidra20.webp]]
   
   **This will then launch a graphical representation of the function currently displayed in the ‘Listing’ window.**
   ![[ghidra21.webp]]
   
   **Zooming in on the graph allows the analyst to see more clearly what decisions are made by the malware and the flow taken by the malware depending on certain conditions.**
   ![[ghidra22.webp]]
   - In the image above I have highlighted where I have identified that the function is calling ‘GetStartupInfoA’ so this tells me that this function is retrieving the startup information of the compromised device.
   - Double-clicking on the name of any function that is being called within the graph will take the user to that function and update the display to show the newly selected function.

### Searching Strings
   **By clicking on the ‘Windows’ option on the toolbar tab and selecting ‘Defined Strings’, Ghidra will list the strings within the executable.**
   ![[ghidra23.webp]]
   
   
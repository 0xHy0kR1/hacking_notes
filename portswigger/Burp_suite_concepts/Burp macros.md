## What is Burp Macro?
- The word **Macro** literally means “a single instruction that a computer automatically reads as a set of instructions necessary to do a particular task”.
- Macros is plural of Macro and is also used in Microsoft Word. In **Word**, you can automate frequently used tasks by creating and running **macros**.
- **Macros** is “a series of commands and instructions that you group together as a single command to accomplish a task automatically.”

## What is the need of Burp macro?
![[macros1.png]]

## Quick Introduction to Burp Macros & its components

Burp Macros can be accessed from **Settings >Sessions tab**
![[macros2.png]]

**Burp Sessions tab has three components that work together to automate your process. The three components are-**
1. **Session handling rules**
	- which help you to define the rules and scope for each session Burp carries out.
Learn more --> [[session handling rules]]

2. **Cookie Jar**
	- that stores all the cookies issued by the visited website.

3. **Macros**
	- defines the sequence of steps that are to be followed in each session.

## Practical demonstration:
visite link --> https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-infinite-money
**Overview of the lab :**

A vulnerable shopping website has a logic flaw in its purchasing flow and we need to exploit it to buy a leather jacket from your user account with credentials **_wiener:peter._**

The user account has a $100 store credit and an option to redeem a gift card worth $10 which can be bought from the store and then can be redeemed by entering a code on the “My Account” page, as you can see in the images below :

![[macros3.png]]
![[macros4.png]]

When you explore the home page and move to the end of the page, there is an option to sign up for the newsletter. When you sign up with a random email id, you get a coupon code that can be used to get a discount during checkout.

![[macros5.png]]

When we add a gift card to the cart and apply coupon code generated by signing up to the newsletter, we are charged $7 to the store credit and a gift card code is generated which can be redeemed on my account page (image shown earlier).
![[macros6.png]]

### Summary of how we purchase jacket for free:
- Now when we go back and redeem the coupon, our new store balance becomes $103, which is the logic flaw in purchasing flow. This is because if we follow the same process a number of times, we can increase our store credit enough to buy the leather jacket, which is the aim of the lab.

Before we figure out the way to do that, let’s calculate how many requests we need to make to collect the required store credit :

Cost of the leather jacket = **$1337**

Store credit= **$103**

The amount required to purchase the jacket = $**1337–$103 = $1234**

Now we collect an extra $3 after redeeming each gift card.

So, the number of times we need to repeat the same process= **1234/3 = 411.3333**

411.333 can be rounded up as **412.**

This means that we need to repeat the same requests more than 400 times in order to increase our store credit to the required amount. In the next section, I will demonstrate how can we achieve that using Burp Macros

## How to use Burp Macros?
- In order to do these iterations, our macro will need session handling information. Hence, we need to configure the same in the Session Handling Rules Editor.
1. To open this, click on “add” under the session handling rules (in Project Options).
![[macros7.png]]

2. Define the scope of the attack by clicking on “Add” and from the pop-up under the **Scope** tab, select “Include all URLs”
![[macros8.png]]

3. Go back to the “Details” tab in the session handling rules editor and click on **_add > Run a Macro_** which will define the sequence of steps.
![[macros9.png]]

4. Click on ‘add’ again to define the sequence of steps.
![[macros10.png]]

5. Macros recorder allows picking requests from your proxy history. For this case, you can include the following sequential requests from your proxy history by using control and left-click :
**_i)_** **_POST/ cart_**

**_ii)_** **_POST / cart/coupon_**

**_iii)_** **_POST/cart/checkout_**

**_iv)_** **_GET/cart/order-confirmation?order-confirmed=true_**

**_v)_** **_POST/gift-card_**
![[macros11.png]]

6. Click OK, the Macro editor will appear where you can configure items. Verify if the sequence of items is correct or you can select the request and move up or down.
- In few scenarios like ours, two requests might be inter-dependent and we need to specify the relation to Macros so that the same can be repeated in all the requests.
- Select the fourth request in Macro editor and click on configure item.
![[macros12.png]]
![[macros13.png]]

7. A new dialogue box appears. Under define “custom parameter”, type **gift-card** and move down on the request to find the gift coupon code and select it to highlight it. Now click OK.
We perform this step because this request generates a gift-card coupon code which is redeemed in the next step. Highlight the coupon code to define the parameter value of this particular request.
![[macros14.png]]
Under parameter handling, we can see the “gift-card” parameter which we set in the previous response

8. Burp Macros now needs to pick up this code from request 4 and redeem it in request 5. To define this, Click on the drop-down menu and select “**_Derive from prior response”_** which makes these two responses interdependent.
This means that now the fifth request in which we enter the gift-card coupon to redeem the coupon, we define the rule for succeeding requests to use the code derived in the previous step.
![[macros15.png]]
![[macros16.png]]

9. This will keep adding credit to our account. The next step is to test if our Macro runs correctly and performs the intended attack. This is a cool feature because it gives a demo on whether the request is working correctly and all rules are correctly defined. On Macro editor screen, click on **_Test Macro_** to check the same.
![[macros17.png]]
When the Macro test finishes, we can see the result. We have to check if the fifth request has a generated a coupon code. (**_derived parameter: gift-card_**). The status code should also be a success.

## What if the coupon code is not generated?
**Some reasons why your coupon code is not generating could be :**
- 4th and 5th requests are not configured correctly
- The coupon code in the 4th request is not highlighted and so the value of the custom parameter is not defined.